"use client";

import { useEffect, useState } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import { supabase } from "@/lib/supabase/client";
import Image from "next/image";

export default function LoginPage() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [email, setEmail] = useState("");
  const [pass, setPass] = useState("");
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  // Jika sudah login, langsung arahkan ke dashboard/tujuan
  useEffect(() => {
    let active = true;
    (async () => {
      const { data } = await supabase.auth.getUser();
      if (!active) return;
      if (data.user) {
        const target = searchParams.get("redirectedFrom") || "/dashboard";
        router.replace(target);
      }
    })();
    return () => {
      active = false;
    };
  }, [router, searchParams]);

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    setErr(null);
    setLoading(true);
    const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
    setLoading(false);
    if (error) {
      setErr(error.message);
      return;
    }
    // Beri sedikit waktu agar cookie Supabase terset sebelum diarahkan.
    await new Promise((r) => setTimeout(r, 150));
    const target = searchParams.get("redirectedFrom") || "/dashboard";
    router.replace(target);
  }

  return (
    <div className="min-h-screen grid grid-cols-1 md:grid-cols-2">
      {/* Left info panel */}
      <div className="relative hidden md:flex items-center justify-center overflow-hidden p-12 text-white" style={{
        background: "radial-gradient(1200px 600px at -10% -10%, rgba(255,255,255,0.08), transparent 60%), radial-gradient(800px 400px at 120% 20%, rgba(255,255,255,0.08), transparent 60%), linear-gradient(135deg, var(--primary-700), var(--primary-600), #1fc3b3)",
      }}>
        <div className="max-w-xl">
          <div className="mb-6">
            <Image src="/tindik-anting-logo.png" alt="PKMK" width={220} height={80} priority />
          </div>
          <h2 className="text-4xl font-semibold leading-tight">Aplikasi Intervensi Stunting & Monev PKMK</h2>
          <p className="mt-4 text-white/90 text-sm">
            Aplikasi Intervensi Stunting dan Monitoring Evaluasi menggunakan formula ONS (Oral Nutrition Supplement)
            atau PKMK (Pangan Olahan untuk Keperluan Medis Khusus) dengan pendampingan dan asistensi medis oleh
            Dokter Pedriatrik Dinas Kesehatan Kabupaten Malang.
          </p>
        </div>
      </div>

      {/* Right login panel */}
      <div className="flex items-center justify-center bg-[var(--background)] p-6 md:p-10">
        <div className="w-[360px] md:w-[380px]">
          <div className="bg-[var(--surface)] border border-[var(--border)] shadow-md rounded-[1.25rem] p-6 md:p-7">
            <div className="mb-6">
              <div className="inline-flex items-center gap-2">
                <span className="inline-block h-2.5 w-2.5 rounded-full bg-[var(--primary)]" />
                <span className="text-sm font-semibold text-[var(--primary-700)]">PKMK</span>
              </div>
              <h1 className="mt-2 text-2xl font-semibold text-[var(--foreground)]">Masuk</h1>
              <p className="text-sm text-[var(--muted)]">Gunakan kredensial Supabase Auth</p>
            </div>

            <form onSubmit={onSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-[var(--foreground)] mb-1">Email</label>
                <input
                  type="email"
                  className="w-full h-11 rounded-lg border border-[var(--border)] bg-white px-3 text-[15px] focus:outline-none focus:ring-2 focus:ring-[var(--primary)]"
                  placeholder="nama@dinkes.go.id"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  required
                  autoFocus
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-[var(--foreground)] mb-1">Password</label>
                <input
                  type="password"
                  className="w-full h-11 rounded-lg border border-[var(--border)] bg-white px-3 text-[15px] focus:outline-none focus:ring-2 focus:ring-[var(--primary)]"
                  placeholder="********"
                  value={pass}
                  onChange={(e) => setPass(e.target.value)}
                  required
                />
              </div>

              {err && (
                <p className="text-sm text-red-700 bg-red-50 border border-red-200 rounded-lg p-2">
                  {err}
                </p>
              )}

              <button
                type="submit"
                disabled={loading}
                className="w-full rounded-full bg-[var(--primary-600)] hover:bg-[var(--primary-700)] text-white font-semibold py-2.5 transition disabled:opacity-60"
              >
                {loading ? "Memproses..." : "Masuk"}
              </button>
            </form>

            <p className="mt-4 text-xs text-[var(--muted)]">
              Hubungi superadmin jika belum punya akun.
            </p>
          </div>

          <p className="text-center text-xs text-[var(--muted)] mt-6">
            © Dinkes Kab. Malang — Sistem Pelaporan PKMK
          </p>
        </div>
      </div>
    </div>
  );
}

